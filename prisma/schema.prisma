// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 認証・ユーザー管理
// ============================================

enum UserRole {
  CLIENT          // クライアント
  INTERNAL_STAFF  // 所内担当
  ATTORNEY        // 弁理士
  ADMIN           // 管理者
}

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean   @default(false) @map("email_verified")
  image         String    @default("")
  role          UserRole  @default(CLIENT)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")
  
  sessions      Session[]
  accounts      Account[]
  client        Client?
  attorney      Attorney?
  internalStaff InternalStaff?
  cases         Case[]
  sentMessages  Message[]   @relation("MessageSender")
  messageReads  MessageRead[] @relation("MessageReadUser")

  @@unique([email])
  @@map("users")
}

model Session {
  id        String   @id
  expiresAt DateTime @map("expires_at")
  token     String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("sessions")
}

// OAuth(Google/GitHub ログイン)やパスワード認証用
model Account {
  id                    String    @id
  accountId             String    @map("account_id")
  providerId            String    @map("provider_id")
  userId                String    @map("user_id")
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?   @map("access_token")
  refreshToken          String?   @map("refresh_token")
  idToken               String?   @map("id_token")
  accessTokenExpiresAt  DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  scope                 String?
  password              String?   // ハッシュ化されたパスワード（better-authが自動管理）
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@map("accounts")
}

// メール認証・パスワードリセット機能用
model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("verifications")
}

// ============================================
// 顧客情報
// ============================================

enum ClientType {
  INDIVIDUAL   // 個人
  CORPORATE    // 法人
}

model Client {
  id                    String     @id @default(cuid())
  userId                String     @unique @map("user_id")
  user                  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 顧客番号: MJ + 4桁の番号 (例: MJ0001)
  // アカウント作成時に自動発行される
  customerNumber        String     @unique @map("customer_number")
  
  clientType            ClientType @default(INDIVIDUAL) @map("client_type")
  
  // 法人情報（法人の場合のみ使用）
  companyName           String     @default("") @map("company_name")
  department            String     @default("")
  position              String     @default("")
  
  // 共通情報
  phoneNumber           String     @default("") @map("phone_number")
  address               String     @default("")
  
  createdAt             DateTime   @default(now()) @map("created_at")
  updatedAt             DateTime   @updatedAt @map("updated_at")

  @@index([customerNumber])
  @@map("clients")
}

// ============================================
// スタッフ情報
// ============================================

model Attorney {
  id            String   @id @default(cuid())
  userId        String   @unique @map("user_id")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // スタッフ番号（将来的に使用）
  staffNumber   String?  @map("staff_number")
  
  // 所属部署・専門分野など（将来的に使用）
  department    String   @default("") @map("department")
  specialty     String   @default("") @map("specialty")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // リレーション
  assignedCases Case[]   @relation("CaseAttorney")

  @@map("attorneys")
}

model InternalStaff {
  id            String   @id @default(cuid())
  userId        String   @unique @map("user_id")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // スタッフ番号（将来的に使用）
  staffNumber   String?  @map("staff_number")
  
  // 所属部署など（将来的に使用）
  department    String   @default("") @map("department")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // リレーション
  assignedCases Case[]   @relation("CaseInternalStaff")

  @@map("internal_staff")
}

// ============================================
// 商標案件管理
// ============================================

enum TrademarkType {
  TEXT          // 文字商標
  LOGO          // ロゴ・図形商標
}

enum ConsultationRoute {
  AI_SELF_SERVICE          // AI活用型（簡易型）: LLM主導での調査・願書作成
  ATTORNEY_CONSULTATION     // 弁理士相談型: 弁理士が直接対応・詳細調査
}

enum CaseStatus {
  DRAFT                           // 下書き
  TRADEMARK_REGISTERED            // 新規商標済
  PRELIMINARY_RESEARCH_IN_PROGRESS // 事前調査中
  RESEARCH_RESULT_SHARED          // 調査結果共有
  PREPARING_APPLICATION           // 出願準備中(入金済)
  APPLICATION_CONFIRMED           // 願書確定
  APPLICATION_SUBMITTED           // 出願受付済
  UNDER_EXAMINATION               // 審査中
  OA_RECEIVED                     // OA受領
  RESPONDING_TO_OA                // 中間対応中
  FINAL_RESULT_RECEIVED           // 最終結果受領
  PAYING_REGISTRATION_FEE         // 登録料納付中
  REGISTRATION_COMPLETED           // 登録完了
  AWAITING_RENEWAL                 // 更新待ち
  IN_DISPUTE                       // 係争中(異議申立・無効審判等)
  REJECTED                         // 拒絶確定
  ABANDONED                        // 放棄
}

model Case {
  id                    String      @id @default(cuid())
  
  // 整理番号: MJ + 顧客番号 + 顧客の通し番号 (例: MJ00010001)
  // 案件作成時に自動発行される
  caseNumber            String      @unique @map("case_number")
  
  // 顧客ごとの通し番号（4桁）
  // 同じ顧客の案件が増えるたびにインクリメントされる
  sequenceNumber        Int         @default(1) @map("sequence_number")
  
  // 基本情報
  title                 String
  trademarkType         TrademarkType @map("trademark_type")
  applicant             String
  classes               String[]      // 区分コードの配列（例: ["1", "42"]）
  
  // 商標情報（Json形式で保存）
  // 文字商標の場合: { text: string, reading: string }
  // ロゴ・図形商標の場合: { imageData: string, logoText?: string, logoTextReading?: string }
  trademarkDetails      Json        @map("trademark_details")
  
  // 区分選択情報（Json形式で保存）
  // AiClassSelection[]: [{ classCode: string, details: string[] }]
  // 登録区分（カテゴリ）と具体的な区分を含む
  classSelections       Json?       @map("class_selections")
  
  // 登録区分カテゴリ（商品・サービス、商品、サービス）
  classCategory         String?     @map("class_category")
  
  // 商品・サービス情報
  productService        String?     @map("product_service")
  
  // ステータス
  status                CaseStatus  @default(DRAFT)
  
  // 相談ルート（AI活用型 or 弁理士相談型）
  consultationRoute     ConsultationRoute? @map("consultation_route")
  consultationStarted   Boolean     @default(false) @map("consultation_started")
  
  // 申込情報（Json形式で保存）
  // 出願人情報、連絡先情報などを含む
  clientIntake          Json?       @map("client_intake")
  
  // メモ
  notes                 String?
  
  // クライアント（案件作成者）
  userId                String      @map("user_id")
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 担当者
  assignedAttorneyId    String?     @map("assigned_attorney_id")
  assignedAttorney      Attorney?   @relation("CaseAttorney", fields: [assignedAttorneyId], references: [id], onDelete: SetNull)
  assignedInternalStaffId String?   @map("assigned_internal_staff_id")
  assignedInternalStaff InternalStaff? @relation("CaseInternalStaff", fields: [assignedInternalStaffId], references: [id], onDelete: SetNull)
  
  // 出願情報
  applicationNumber     String?     @map("application_number")
  applicationDate       DateTime?   @map("application_date")
  
  // 登録情報
  registrationNumber    String?     @map("registration_number")
  registrationDate      DateTime?   @map("registration_date")
  
  // 論理削除
  deletedAt             DateTime?   @map("deleted_at")
  
  createdAt             DateTime    @default(now()) @map("created_at")
  updatedAt             DateTime    @updatedAt @map("updated_at")
  
  // リレーション
  messages              Message[]

  @@index([userId])
  @@index([status])
  @@index([caseNumber])
  @@index([deletedAt])
  @@index([assignedAttorneyId])
  @@index([assignedInternalStaffId])
  @@map("cases")
}

// ============================================
// 通信管理
// ============================================

model Message {
  id            String      @id @default(cuid())
  
  // 案件への紐づけ
  caseId        String      @map("case_id")
  case          Case        @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  // 送信者
  senderId      String      @map("sender_id")
  sender        User        @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  
  // メッセージ内容
  content       String      @db.Text
  subject       String?     // 件名（オプション）
  
  // 重要なメッセージフラグ（Outlookメールのように）
  isFlagged     Boolean     @default(false) @map("is_flagged")
  
  // 添付ファイル（将来的に使用）
  attachments   Json?       // [{ name: string, url: string, size: number }]
  
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  
  // リレーション
  reads         MessageRead[]

  @@index([caseId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

model MessageRead {
  id            String      @id @default(cuid())
  
  // メッセージへの紐づけ
  messageId     String      @map("message_id")
  message       Message     @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  // 読んだユーザー
  userId        String      @map("user_id")
  user          User        @relation("MessageReadUser", fields: [userId], references: [id], onDelete: Cascade)
  
  // 既読日時
  readAt        DateTime    @default(now()) @map("read_at")

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
  @@map("message_reads")
}
